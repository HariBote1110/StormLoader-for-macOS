# macOS版 StormLoader 開発ドキュメント

このドキュメントは、オリジナルのWindows版`StormLoader`を参考に、macOSユーザー向けにJavaScript (Electron) で開発されたMODマネージャーの仕様と実装の要点をまとめたものです。

## 1. 開発目標

-   MOD導入が困難だったmacOSユーザーのために、使いやすいMOD管理ツールを提供する。
-   主要機能は`.slp`ファイルの管理とMODの有効化/無効化に絞り、迅速な開発を目指す。
-   オリジナルの`StormLoader`が持つ便利な機能（プロファイル、クリーンなMOD適用）を取り入れつつ、UI/UXを改善する。

---

## 2. 実装された機能一覧

### 2.1. MOD管理の基本機能
-   **.slpファイルの追加**: ダイアログから`.slp`（実体は.zip）ファイルを選択し、アプリケーションの管理ディレクトリ（`~/Library/Application Support/stormloader-macos/mods/`）に展開します。
    -   zipファイル内にMOD名のフォルダがネストされている場合でも、自動で正しい階層に整理するロジックを実装しています。
-   **メタデータ解析**: 展開後、`Metadata.xml`を読み込み、MODの「作者」と「バージョン」をUIに表示します。
-   **MODの有効化/無効化**:
    -   UI上のトグルスイッチで、各MODの有効/無効を切り替えます。
    -   変更は即時適用されず、「変更を適用」ボタンが押されるまで保留されます。
-   **変更の一括適用**:
    -   「変更を適用」ボタンを押すと、すべての変更が一度にゲームファイルに反映されます。
    -   UIには未適用の変更があることを示すインジケーターが表示されます。

### 2.2. 安全なMOD適用システム
-   **バニラ`rom`のバックアップ**:
    -   初回にゲームディレクトリ（`Stormworks.app`）を設定した際、オリジナルの`rom`フォルダの完全なバックアップを自動で作成します。
    -   「バニラROMバックアップを更新」ボタンから、手動でバックアップを最新の状態に更新できます。
-   **クリーンな再適用ロジック**:
    -   「変更を適用」ボタンが押されると、以下の安全な手順でMODが適用されます。
        1.  現在のゲーム内の`rom`フォルダを削除。
        2.  バックアップしておいたバニラの`rom`フォルダをコピーして復元。
        3.  UI上で有効になっているすべてのMODを、クリーンな`rom`フォルダに対して再インストール。
    -   これにより、MODの無効化や競合によってファイルが不整合な状態になるのを防ぎます。

### 2.3. プレイリスト（プリセット）機能
-   **プレイリストの保存**:
    -   現在のMODの有効/無効の組み合わせを、名前を付けて「プレイリスト」として保存できます。
    -   UIの現在の状態を元に「新規保存」または「上書き保存」が可能です。
-   **プレイリストのロード**:
    -   保存したプレイリストを選択して「ロード」すると、MODの有効/無効状態が瞬時に切り替わり、「変更を適用」待ちの状態になります。
-   **プレイリストの管理**:
    -   プレイリストの「名前の変更」と「削除」が可能です。

### 2.4. UI/UXの改善
-   **2カラムレイアウト**: 左にMODリスト、右に各種コントロールパネルを配置し、視認性と操作性を向上させました。
-   **多言語対応（国際化）**:
    -   日本語と英語の言語ファイルを`locales`フォルダに用意。
    -   アプリケーションメニューから言語を切り替えることができ、再起動するとUIの表示言語が変更されます。
-   **プライバシー保護**:
    -   ゲームのROMディレクトリへのフルパスは、配信などで意図せず表示されることがないよう、デフォルトで非表示になっています。
    -   パス表示エリアをクリックすることで、表示/非表示を切り替えられます。
-   **非同期処理とローディング表示**:
    -   ファイルのコピーやリストアなど、時間のかかる処理中はローディングオーバーレイを表示し、ユーザーが操作不能になっていないことを明確に伝えます。

### 2.5. 将来性
-   **クロスプラットフォーム対応の準備**: ゲームディレクトリの設定ロジックにOS判定を導入済み。macOSでは`.app`ファイルを、Windowsではフォルダを選択するように処理を分岐させており、将来的なWindows対応を容易にしています。

---

## 3. 今後の展望

-   **MODの削除機能**: 現在はMODをリストから削除するUIがありませんが、`store.json`からMOD情報を削除し、管理ディレクトリからMODファイルを削除する機能を追加できます。
-   **エラーハンドリングの強化**: `alert`や`console.error`で表示しているエラーを、より親切なUIでユーザーに提示する。
-   **自動アップデート機能**: Electronの`autoUpdater`モジュールを利用して、アプリケーションの新しいバージョンを自動で通知・更新する機能。
